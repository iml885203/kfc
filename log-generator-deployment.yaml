apiVersion: apps/v1
kind: Deployment
metadata:
  name: log-generator
  labels:
    app: log-generator
spec:
  replicas: 1
  selector:
    matchLabels:
      app: log-generator
  template:
    metadata:
      labels:
        app: log-generator
    spec:
      containers:
        - name: log-generator
          image: alpine:latest
          command: ["/bin/sh"]
          args:
            - -c
            - |
              #!/bin/sh

              # Install bash for better scripting
              apk add --no-cache bash coreutils util-linux

              bash <<'SCRIPT'
              LOG_LEVELS=("Information" "Warning" "Error" "Debug")
              SOURCES=("Microsoft.AspNetCore.HttpLogging.HttpLoggingMiddleware" "Kfc.Core.Service" "Microsoft.EntityFrameworkCore.Database.Command" "Kfc.Core.Logging.HttpClientLoggingHandler")
              ENDPOINTS=("/api/users" "/api/orders" "/api/products" "/api/auth/login" "/api/payments")
              METHODS=("GET" "POST" "PUT" "DELETE")
              STATUS_CODES=(200 201 400 401 403 404 500)

              generate_trace_id() {
                echo "00-$(cat /dev/urandom | tr -dc 'a-f0-9' | head -c 32)-$(cat /dev/urandom | tr -dc 'a-f0-9' | head -c 16)-01"
              }

              generate_span_id() {
                echo "$(cat /dev/urandom | tr -dc 'a-f0-9' | head -c 16)"
              }

              while true; do
                LEVEL=${LOG_LEVELS[$RANDOM % ${#LOG_LEVELS[@]}]}
                SOURCE=${SOURCES[$RANDOM % ${#SOURCES[@]}]}
                ENDPOINT=${ENDPOINTS[$RANDOM % ${#ENDPOINTS[@]}]}
                METHOD=${METHODS[$RANDOM % ${#METHODS[@]}]}
                STATUS=${STATUS_CODES[$RANDOM % ${#STATUS_CODES[@]}]}
                TRACE_ID=$(generate_trace_id)
                SPAN_ID=$(generate_span_id)
                DURATION=$((100 + RANDOM % 2000))

                TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%S.%3NZ")

                case $LEVEL in
                  "Information")
                    if [ $((RANDOM % 3)) -eq 0 ]; then
                      echo "[$TIMESTAMP INF] HTTP $METHOD $ENDPOINT responded $STATUS in ${DURATION}ms TraceId:$TRACE_ID SpanId:$SPAN_ID"
                    else
                      echo "[$TIMESTAMP INF] $SOURCE: RequestPath: \"$ENDPOINT\", StatusCode: $STATUS, Duration: ${DURATION}ms, TraceIdentifier: $TRACE_ID"
                    fi
                    ;;
                  "Warning")
                    echo "[$TIMESTAMP WRN] $SOURCE: Database query took longer than expected. Duration: ${DURATION}ms, Query: \"SELECT * FROM Users WHERE Id = @p0\" TraceId:$TRACE_ID"
                    ;;
                  "Error")
                    ERROR_MSGS=("Connection timeout to database" "Failed to authenticate user" "Invalid request payload" "Service unavailable")
                    ERROR_MSG=${ERROR_MSGS[$RANDOM % ${#ERROR_MSGS[@]}]}
                    echo "[$TIMESTAMP ERR] $SOURCE: $ERROR_MSG. RequestPath: $ENDPOINT, Exception: System.Exception: $ERROR_MSG TraceId:$TRACE_ID SpanId:$SPAN_ID"
                    ;;
                  "Debug")
                    echo "[$TIMESTAMP DBG] $SOURCE: Processing request for $ENDPOINT with parameters: {\"userId\":\"$(uuidgen | tr '[:upper:]' '[:lower:]')\",\"action\":\"${METHOD}\"} TraceId:$TRACE_ID"
                    ;;
                esac

                # Random sleep between 0.5 and 3 seconds
                sleep $(awk -v min=0.5 -v max=3 'BEGIN{srand(); print min+rand()*(max-min)}')
              done
              SCRIPT
          resources:
            limits:
              memory: "128Mi"
              cpu: "100m"
            requests:
              memory: "64Mi"
              cpu: "50m"
